<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>THEVTIG | BRVM Live Ticker</title>
  <style>
    :root{
      --bg:#0e1510;
      --panel:#121b14;
      --text:#eef6ef;
      --muted:rgba(238,246,239,.72);
      --green:#2e7d32;
      --deep:#1b5e20;
      --down:#ff5a6b;
      --up:#7dff9c;
      --neu:#cbd5cb;
      --border:rgba(255,255,255,.10);
    }
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{background:var(--deep);padding:14px 18px;}
    header h1{margin:0;font-size:16px;letter-spacing:.4px;}
    header p{margin:6px 0 0;font-size:12px;color:rgba(255,255,255,.85)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px;}

    .bar{
      background: linear-gradient(90deg, rgba(46,125,50,.28), rgba(18,27,20,.35));
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      position:relative;
    }

    .barTop{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;
      color:var(--muted);
    }

    button{
      border:0;background:var(--green);color:white;
      padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;
    }
    button:disabled{opacity:.65;cursor:not-allowed;}

    /* Rolling ticker */
    .tickerViewport{
      width:100%;
      overflow:hidden;
      white-space:nowrap;
    }
    .tickerTrack{
      display:inline-flex;
      gap:14px;
      padding:12px;
      align-items:center;
      will-change: transform;
      animation: scroll 45s linear infinite;
    }
    .tickerItem{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      background: rgba(0,0,0,.12);
      font-size:13px;
    }
    .code{font-weight:900;letter-spacing:.3px;}
    .price{color:rgba(255,255,255,.92); font-weight:800;}
    .pct{font-weight:900;}
    .up{color:var(--up);}
    .dn{color:var(--down);}
    .nul{color:var(--neu);}

    /* Pause on hover (nice UX) */
    .bar:hover .tickerTrack{ animation-play-state: paused; }

    @keyframes scroll{
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    .note{margin-top:10px;color:var(--muted);font-size:12px;}
    a{color:var(--up);text-decoration:none;font-weight:800;}
  </style>
</head>

<body>
<header>
  <h1>THEVTIG — BRVM Live Ticker</h1>
  <p>Rolling BRVM quotes (public webpage extraction). Not investment advice.</p>
</header>

<div class="wrap">
  <div class="bar">
    <div class="barTop">
      <div>
        <strong>Status:</strong> <span id="status">Loading…</span>
        &nbsp;•&nbsp;
        <strong>Updated:</strong> <span id="updated">—</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="tickerViewport">
      <div class="tickerTrack" id="track">
        <!-- items injected -->
      </div>
    </div>
  </div>

  <div class="note">
    Source: <a href="https://www.brvm.org/" target="_blank" rel="noreferrer">brvm.org</a>.
    If BRVM changes its HTML structure, this tape may need an update.
  </div>
</div>

<script>
  const statusEl  = document.getElementById("status");
  const updatedEl = document.getElementById("updated");
  const refreshBtn= document.getElementById("refreshBtn");
  const trackEl   = document.getElementById("track");

  const SOURCE = "https://www.brvm.org/";
  const PROXY  = (u) => `https://r.jina.ai/http://r.jina.ai/${u}`;

  function classifyPct(pctText){
    // pctText examples: "-0,10%" "0,28%" "0,00%"
    const t = (pctText || "").replace("%","").replace(",",".").trim();
    const v = Number(t);
    if (!isFinite(v)) return "nul";
    if (v > 0) return "up";
    if (v < 0) return "dn";
    return "nul";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function buildItem(code, price, pct){
    const cls = classifyPct(pct);
    return `
      <div class="tickerItem">
        <span class="code">${escapeHtml(code)}</span>
        <span class="price">${escapeHtml(price)}</span>
        <span class="pct ${cls}">${escapeHtml(pct)}</span>
      </div>
    `;
  }

  async function fetchBRVMTape(){
    const res = await fetch(PROXY(SOURCE), { cache: "no-store" });
    if (!res.ok) throw new Error("BRVM fetch failed");
    const html = await res.text();

    // Parse HTML
    const doc = new DOMParser().parseFromString(html, "text/html");

    // BRVM uses owl-carousel items; each item has spans:
    // <div class="item"><span>CODE</span> <span>PRICE</span> <span>%</span> ...</div>
    const items = [...doc.querySelectorAll("#slide-seance .item")];

    // If selector changes, try fallback:
    const useItems = items.length ? items : [...doc.querySelectorAll(".owl-carousel .item")];

    const rows = [];
    for (const it of useItems){
      const spans = [...it.querySelectorAll("span")].map(s => s.textContent.trim()).filter(Boolean);
      if (spans.length >= 3){
        rows.push({ code: spans[0], price: spans[1], pct: spans[2] });
      }
    }
    return rows;
  }

  function renderTape(rows){
    if (!rows.length){
      trackEl.innerHTML = `<div style="padding:12px;color:rgba(255,255,255,.85)">No ticker items found on BRVM page.</div>`;
      return;
    }

    // Build once…
    const chunk = rows.map(r => buildItem(r.code, r.price, r.pct)).join("");

    // Duplicate the chunk so animation can loop smoothly
    // (track moves -50% in CSS)
    trackEl.innerHTML = chunk + chunk;

    // Adjust speed automatically: more items => longer scroll
    const seconds = Math.min(90, Math.max(35, rows.length * 2));
    trackEl.style.animationDuration = `${seconds}s`;
  }

  async function refresh(){
    refreshBtn.disabled = true;
    statusEl.textContent = "Refreshing…";

    try{
      const rows = await fetchBRVMTape();
      renderTape(rows);

      statusEl.textContent = "Live tape loaded.";
      updatedEl.textContent = new Date().toLocaleString();
    } catch (e){
      console.error(e);
      statusEl.textContent = "Error loading BRVM tape. Try again.";
    } finally {
      refreshBtn.disabled = false;
    }
  }

  refreshBtn.addEventListener("click", refresh);
  refresh();

  // Auto refresh every 30 minutes (safer for public scraping)
  setInterval(refresh, 1800000);
</script>
</body>
</html>
