import pandas as pd
import yfinance as yf
import requests
from datetime import datetime

# --- Configure what you track ---
YF_TICKERS = {
    "S&P 500 (SPY)": "SPY",
    "NASDAQ 100 (QQQ)": "QQQ",
    "Dow Jones (DIA)": "DIA",
    "Nikkei 225": "^N225",
    "Hang Seng": "^HSI",
    "Euro Stoxx 50": "^STOXX50E",
    "DAX": "^GDAXI",
    "FTSE 100": "^FTSE",
    "Gold": "GC=F",
    "Oil (WTI)": "CL=F",
    "US 10Y Yield": "^TNX",
    "EUR/USD": "EURUSD=X",
}

COINGECKO = {
    "Bitcoin": "bitcoin",
    "Ethereum": "ethereum",
}

def fetch_yfinance_snapshot(tickers: dict) -> pd.DataFrame:
    symbols = list(tickers.values())
    data = yf.download(symbols, period="7d", interval="1d", auto_adjust=True, progress=False)["Close"]
    if isinstance(data, pd.Series):
        data = data.to_frame()
    data = data.dropna(how="all")

    rows = []
    for label, sym in tickers.items():
        if sym not in data.columns:
            continue
        s = data[sym].dropna()
        if len(s) < 2:
            continue
        last = float(s.iloc[-1])
        prev = float(s.iloc[-2])
        chg = last - prev
        pct = (chg / prev) * 100 if prev != 0 else 0.0
        rows.append([label, sym, last, chg, pct])
    return pd.DataFrame(rows, columns=["Market", "Symbol", "Last", "Change", "Change_%"])

def fetch_coingecko_snapshot(coins: dict) -> pd.DataFrame:
    ids = ",".join(coins.values())
    url = "https://api.coingecko.com/api/v3/simple/price"
    params = {"ids": ids, "vs_currencies": "usd", "include_24hr_change": "true"}
    r = requests.get(url, params=params, timeout=20)
    r.raise_for_status()
    js = r.json()

    rows = []
    for label, coin_id in coins.items():
        last = float(js[coin_id]["usd"])
        pct = float(js[coin_id].get("usd_24h_change", 0.0))
        chg = last * (pct / 100.0)
        rows.append([label, coin_id, last, chg, pct])
    return pd.DataFrame(rows, columns=["Market", "Symbol", "Last", "Change", "Change_%"])

def to_html_dashboard(df: pd.DataFrame, out_file="markets_dashboard.html"):
    df = df.copy()
    df["Last"] = df["Last"].map(lambda x: f"{x:,.2f}")
    df["Change"] = df["Change"].map(lambda x: f"{x:+,.2f}")
    df["Change_%"] = df["Change_%"].map(lambda x: f"{x:+.2f}%")

    html = f"""
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>THEVTIG | Global Markets Dashboard</title>
  <style>
    body {{ font-family: Arial, sans-serif; margin: 0; background: #f7f9f8; color:#111; }}
    header {{ background: #1b5e20; color: #fff; padding: 18px 22px; }}
    header h1 {{ margin: 0; font-size: 20px; letter-spacing: .5px; }}
    header p {{ margin: 6px 0 0; opacity: .9; }}
    .wrap {{ padding: 18px 22px; max-width: 1100px; margin: 0 auto; }}
    .grid {{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }}
    .card {{ background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.06); border-top: 4px solid #2e7d32; }}
    .name {{ font-weight: 700; margin-bottom: 6px; }}
    .sym {{ font-size: 12px; opacity: .7; margin-bottom: 10px; }}
    .last {{ font-size: 22px; font-weight: 800; }}
    .chg {{ margin-top: 6px; font-weight: 700; }}
    .up {{ color: #1b5e20; }}
    .dn {{ color: #b00020; }}
    .meta {{ margin-top: 18px; font-size: 12px; opacity: .7; }}
    @media (max-width: 900px) {{ .grid {{ grid-template-columns: 1fr; }} }}
  </style>
</head>
<body>
<header>
  <h1>THEVTIG â€” Global Markets Dashboard</h1>
  <p>Live snapshots across US, Asia, Europe, and Crypto.</p>
</header>
<div class="wrap">
  <div class="grid">
"""
    for _, r in df.iterrows():
        cls = "up" if str(r["Change_%"]).startswith("+") else "dn"
        html += f"""
    <div class="card">
      <div class="name">{r['Market']}</div>
      <div class="sym">{r['Symbol']}</div>
      <div class="last">{r['Last']}</div>
      <div class="chg {cls}">{r['Change']} ({r['Change_%']})</div>
    </div>
"""
    html += f"""
  </div>
  <div class="meta">Last updated: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</div>
</div>
</body>
</html>
"""
    with open(out_file, "w", encoding="utf-8") as f:
        f.write(html)
    print(f"Saved: {out_file}")

if __name__ == "__main__":
    df_yf = fetch_yfinance_snapshot(YF_TICKERS)
    df_cg = fetch_coingecko_snapshot(COINGECKO)
    df = pd.concat([df_yf, df_cg], ignore_index=True)
    to_html_dashboard(df, out_file="markets_dashboard.html")
