<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>THEVTIG | Global Markets Dashboard</title>
  <style>
    body{font-family:Arial, sans-serif;margin:0;background:#f7f9f8;color:#111;}
    header{background:#1b5e20;color:#fff;padding:18px 22px;}
    header h1{margin:0;font-size:20px;letter-spacing:.5px;}
    header p{margin:6px 0 0;opacity:.9;}
    .wrap{padding:18px 22px;max-width:1100px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);border-top:4px solid #2e7d32;}
    .name{font-weight:700;margin-bottom:6px;}
    .sym{font-size:12px;opacity:.7;margin-bottom:10px;}
    .last{font-size:22px;font-weight:800;}
    .chg{margin-top:6px;font-weight:700;}
    .up{color:#1b5e20;}
    .dn{color:#b00020;}
    .meta{margin-top:18px;font-size:12px;opacity:.7;display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    button{border:0;background:#2e7d32;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    @media (max-width:900px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<header>
  <h1>THEVTIG — Global Markets Dashboard</h1>
  <p>Live snapshots across US, Asia, Europe, and Crypto.</p>
</header>

<div class="wrap">
  <div class="meta">
    <button id="refreshBtn">Refresh now</button>
    <div id="status">Loading…</div>
    <div id="updated"></div>
  </div>

  <div class="grid" id="cards"></div>

  <div class="meta" style="margin-top:14px;">
    Data sources: Stooq (ETFs/indices via CSV), CoinGecko (crypto). Not investment advice.
  </div>
</div>

<script>
  // --- What we track (ETF proxies for regions) ---
  const MARKETS = [
    { group:"US",      name:"S&P 500 (SPY)",      symbol:"SPY",  source:"stooq" },
    { group:"US",      name:"NASDAQ 100 (QQQ)",   symbol:"QQQ",  source:"stooq" },
    { group:"US",      name:"Dow Jones (DIA)",    symbol:"DIA",  source:"stooq" },

    { group:"Asia",    name:"Japan (EWJ)",        symbol:"EWJ",  source:"stooq" },
    { group:"Asia",    name:"Hong Kong (EWH)",    symbol:"EWH",  source:"stooq" },

    { group:"Europe",  name:"Euro Stoxx (FEZ)",   symbol:"FEZ",  source:"stooq" },
    { group:"Europe",  name:"Germany (EWG)",      symbol:"EWG",  source:"stooq" },
    { group:"Europe",  name:"UK (EWU)",           symbol:"EWU",  source:"stooq" },

    { group:"Macro",   name:"Gold (GLD)",         symbol:"GLD",  source:"stooq" },
    { group:"Macro",   name:"Oil (USO)",          symbol:"USO",  source:"stooq" },

    { group:"Crypto",  name:"Bitcoin",            symbol:"bitcoin",  source:"coingecko" },
    { group:"Crypto",  name:"Ethereum",           symbol:"ethereum", source:"coingecko" }
  ];

  const cardsEl = document.getElementById("cards");
  const statusEl = document.getElementById("status");
  const updatedEl = document.getElementById("updated");
  const refreshBtn = document.getElementById("refreshBtn");

  function cardHTML({name, symbol, last, change, pct, cls, group}) {
    return `
      <div class="card">
        <div class="name">${name}</div>
        <div class="sym">${group} • ${symbol}</div>
        <div class="last">${last}</div>
        <div class="chg ${cls}">${change} (${pct})</div>
      </div>
    `;
  }

  function fmtNum(x, decimals=2) {
    const n = Number(x);
    if (!isFinite(n)) return "—";
    return n.toLocaleString(undefined, {minimumFractionDigits:decimals, maximumFractionDigits:decimals});
  }

  // Fetch last 2 daily closes from Stooq CSV (free, no key)
 async function fetchStooqDaily(symbol) {
  // Use a CORS-friendly proxy for Stooq (GitHub Pages often blocks direct Stooq requests)
  const stooqSym = `${symbol.toLowerCase()}.us`;
  const rawUrl = `https://stooq.com/q/d/l/?s=${encodeURIComponent(stooqSym)}&i=d`;

  // Jina AI proxy returns the page content with permissive CORS headers
 const url = `https://r.jina.ai/http://r.jina.ai/${rawUrl}`;

  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`Stooq proxy error for ${symbol}`);

  const text = await res.text();

  // Extract the CSV lines from the proxy response
  // We keep only lines that look like CSV rows: YYYY-MM-DD,...
  const csvLines = text
  .split("\n")
  .map(l => l.trim())
  .filter(l => l.includes(",") && /^\d{4}-\d{2}-\d{2}/.test(l));

  if (csvLines.length < 2) throw new Error(`Not enough CSV data for ${symbol}`);

  // Parse rows: Date,Open,High,Low,Close,Volume
  const rows = csvLines.map(l => l.split(","));
  const closeIdx = 4;

  const valid = rows
    .map(r => ({ date: r[0], close: Number(r[closeIdx]) }))
    .filter(r => Number.isFinite(r.close));

  if (valid.length < 2) throw new Error(`No valid closes for ${symbol}`);

  const last = valid[valid.length - 1];
  const prev = valid[valid.length - 2];

  const chg = last.close - prev.close;
  const pct = (chg / prev.close) * 100;

  return { last: last.close, change: chg, pct: pct };
}


  // Fetch crypto from CoinGecko
  async function fetchCoinGecko(ids) {
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids.join(","))}&vs_currencies=usd&include_24hr_change=true`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("CoinGecko error");
    return await res.json();
  }

  async function refresh() {
    refreshBtn.disabled = true;
    statusEl.textContent = "Refreshing…";
    updatedEl.textContent = "";

    try {
      cardsEl.innerHTML = "";

      // 1) Crypto batch
      const cryptoItems = MARKETS.filter(m => m.source === "coingecko");
      const cryptoJson = await fetchCoinGecko(cryptoItems.map(x => x.symbol));

      // 2) Other markets
      const results = [];
      for (const m of MARKETS) {
        if (m.source === "coingecko") {
          const obj = cryptoJson[m.symbol];
          const last = obj?.usd;
          const pct = obj?.usd_24h_change ?? 0;
          const chg = last * (pct/100);
          results.push({
            ...m,
            last,
            change: chg,
            pct
          });
        }} else {
  try {
    const s = await fetchStooqDaily(m.symbol);
    results.push({ ...m, last: s.last, change: s.change, pct: s.pct });
  } catch (err) {
    // still render card but show unavailable
    results.push({ ...m, last: NaN, change: NaN, pct: NaN });
  }
}
      // Render cards
      for (const r of results) {
        const cls = r.pct >= 0 ? "up" : "dn";
        const lastStr = (r.source === "coingecko") ? `$${fmtNum(r.last, 2)}` : `$${fmtNum(r.last, 2)}`;
        const chgStr  = `${r.change >= 0 ? "+" : ""}${fmtNum(r.change, 2)}`;
        const pctStr  = `${r.pct >= 0 ? "+" : ""}${fmtNum(r.pct, 2)}%`;

        cardsEl.insertAdjacentHTML("beforeend", cardHTML({
          name: r.name,
          symbol: r.source === "coingecko" ? r.symbol.toUpperCase() : r.symbol,
          last: lastStr,
          change: chgStr,
          pct: pctStr,
          cls,
          group: r.group
        }));
      }

      const now = new Date();
      updatedEl.textContent = `Last updated: ${now.toLocaleString()}`;
      statusEl.textContent = "Live snapshot loaded.";
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Error loading data. Try refresh.";
    } finally {
      refreshBtn.disabled = false;
    }
  }

  refreshBtn.addEventListener("click", refresh);
refresh();

// Smart auto refresh (only during market hours)
setInterval(() => {
  const now = new Date();
  const hour = now.getHours();

  // Only refresh between 8 AM and 6 PM
  if (hour >= 8 && hour <= 18) {
    refresh();
  }
}, 900000); // 15 minutes


</script>
</body>
</html>

